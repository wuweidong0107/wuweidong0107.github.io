<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wuweidong0107.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"changyan","storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="哈喽，我是老吴，继续记录我的学习心得。 一、进步的滞后性我们期望进步是线性：每一个人付出一些努力后，都希望它有立竿见影的效果。 现实是：做出努力后，结果的显现往往滞后。 只有在几个月或几年后，我们才意识到以前学习&#x2F;工作的真正价值。 “失望谷地” 的出现：人们在投入数周或数月的辛勤工作后，却没有任何看得见的效果，于是进入深感沮丧的时期。 如何改变：1&amp;gt; 改变意识。功夫并没有白费，它只是蓄积起">
<meta name="keywords" content="Linux_Program">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux系统编程 &#x2F; triggerhappy 源码分析 &#x2F; 3.select() 的应用">
<meta property="og:url" content="https:&#x2F;&#x2F;wuweidong0107.github.io&#x2F;2020&#x2F;08&#x2F;21&#x2F;Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6Triggerhappy3&#x2F;index.html">
<meta property="og:site_name" content="嵌入式Hacker (es-hacker)">
<meta property="og:description" content="哈喽，我是老吴，继续记录我的学习心得。 一、进步的滞后性我们期望进步是线性：每一个人付出一些努力后，都希望它有立竿见影的效果。 现实是：做出努力后，结果的显现往往滞后。 只有在几个月或几年后，我们才意识到以前学习&#x2F;工作的真正价值。 “失望谷地” 的出现：人们在投入数周或数月的辛勤工作后，却没有任何看得见的效果，于是进入深感沮丧的时期。 如何改变：1&amp;gt; 改变意识。功夫并没有白费，它只是蓄积起">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;wuweidong0107.github.io&#x2F;images&#x2F;life&#x2F;photo&#x2F;20200820.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;wuweidong0107.github.io&#x2F;images&#x2F;linux&#x2F;io&#x2F;select_fd_set.png">
<meta property="og:image" content="https:&#x2F;&#x2F;wuweidong0107.github.io&#x2F;images&#x2F;basic&#x2F;wechat_channel.jpg">
<meta property="og:updated_time" content="2020-08-30T23:49:02.193Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;wuweidong0107.github.io&#x2F;images&#x2F;life&#x2F;photo&#x2F;20200820.jpg">

<link rel="canonical" href="https://wuweidong0107.github.io/2020/08/21/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6Triggerhappy3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Linux系统编程 / triggerhappy 源码分析 / 3.select() 的应用 | 嵌入式Hacker (es-hacker)</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">嵌入式Hacker (es-hacker)</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Embedded bsp developer enjoys thinking and hacking opensource and develop boards(NanoPi, LicheePi, RPi...)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/wuweidong0107" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wuweidong0107.github.io/2020/08/21/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E5%88%86%E6%9E%90%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6Triggerhappy3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="es-hacker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嵌入式Hacker (es-hacker)">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux系统编程 / triggerhappy 源码分析 / 3.select() 的应用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-21 07:48:37" itemprop="dateCreated datePublished" datetime="2020-08-21T07:48:37+08:00">2020-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-31 07:49:02" itemprop="dateModified" datetime="2020-08-31T07:49:02+08:00">2020-08-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux-Program/" itemprop="url" rel="index"><span itemprop="name">Linux-Program</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="/images/life/photo/20200820.jpg" alt=""></p>
<p>哈喽，我是老吴，继续记录我的学习心得。</p>
<h1 id="一、进步的滞后性"><a href="#一、进步的滞后性" class="headerlink" title="一、进步的滞后性"></a>一、进步的滞后性</h1><p><strong>我们期望进步是线性：</strong><br>每一个人付出一些努力后，都希望它有立竿见影的效果。</p>
<p><strong>现实是：</strong><br>做出努力后，结果的显现往往滞后。</p>
<p>只有在几个月或几年后，我们才意识到以前学习/工作的真正价值。</p>
<p><strong>“失望谷地” 的出现：</strong><br>人们在投入数周或数月的辛勤工作后，却没有任何看得见的效果，于是进入深感沮丧的时期。</p>
<p><strong>如何改变：</strong><br>1&gt; 改变意识。功夫并没有白费，它只是蓄积起来了。直到很久以后，以前努力的全部价值才会显露出来。</p>
<p>2&gt; 寻找一些可以帮助自己对抗滞后进步所带来的低落情绪的技巧。例如培养习惯的四大定律，具体的如即时奖励、习惯追踪等。</p>
<hr>
<h1 id="二、triggerhappy-源码分析-3-select-的应用"><a href="#二、triggerhappy-源码分析-3-select-的应用" class="headerlink" title="二、triggerhappy 源码分析 / 3.select() 的应用"></a>二、triggerhappy 源码分析 / 3.select() 的应用</h1><p><strong>正文目录：</strong></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> thd.c / process_events() 源码分析</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span> I/O 多路复用 ( Multiplexing ) 是为了解决什么问题</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="number">3.</span> I/O 多路复用设计思路</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="number">4.</span> select() 的用法</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="number">5.</span> 和 poll/epoll 对比(补充知识，非重点)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="number">6.</span> triggerhappy：thd.c / process_devices() 源码分析</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="number">7.</span> 相关参考</span></pre></td></tr></table></figure>

<p><strong>写作目的：</strong></p>
<ul>
<li>通过阅读 triggerhappy 的源码，学习 I/O 多路复用的方法之一 select() 的使用方法。</li>
</ul>
<a id="more"></a>

<p><strong>测试环境：</strong></p>
<ul>
<li>Ubuntu 16.04</li>
<li>Gcc 5.4.0</li>
</ul>
<h2 id="1-thd-c-process-events-源码分析"><a href="#1-thd-c-process-events-源码分析" class="headerlink" title="1. thd.c / process_events() 源码分析"></a>1. thd.c / process_events() 源码分析</h2><h3 id="1-1-process-events-的作用"><a href="#1-1-process-events-的作用" class="headerlink" title="1.1 process_events() 的作用"></a>1.1 process_events() 的作用</h3><p><strong>1) 作用：</strong></p>
<ul>
<li>监控 input 设备;</li>
<li>读取 input 事件，并执行相应的 action;</li>
<li>检查 socket 是否有接受到命令。</li>
</ul>
<p><strong>2) 调用流程：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">thd.c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    main()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        start_readers()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">            process_events()</span></pre></td></tr></table></figure>

<h3 id="1-2-process-events-的内容：4-个步骤"><a href="#1-2-process-events-的内容：4-个步骤" class="headerlink" title="1.2 process_events() 的内容：4 个步骤"></a>1.2 process_events() 的内容：4 个步骤</h3><p><strong>1) 建立主循环：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( count_devices() &gt; <span class="number">0</span> || cmd_fd != <span class="number">-1</span> ) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    [...]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>2) 在主循环内，使用 select 监测多个 input 设备文件 (重点)：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(...) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    [...]       <span class="comment">// some init for select</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    retval = select(max_fd+<span class="number">1</span>, &amp;rfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tv);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>本文的重点就是了解　select 相关的知识点。</p>
<p><strong>3) select 返回后，调用 process_devices() 读取数据 (重点)：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(...) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    [...]       <span class="comment">// some init for select</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    retval = select(max_fd+<span class="number">1</span>, &amp;rfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tv);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (retval) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        process_devices();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>process_devices() 是 triggerhappy 的重点函数。</strong></p>
<p><strong>先大致了解一下它的作用：</strong><br>对于每一个有待读数据的 input 设备文件，都调用 read() 函数读取数据，然后解析数据，根据解析结果去执行相应的 action，action 在 example.conf 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">$ cat /etc/triggerhappy/triggers.d/example.conf</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">KEY_VOLUMEUP    <span class="number">1</span>        /usr/bin/amixer <span class="built_in">set</span> Master <span class="number">5</span>%+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">...</span></pre></td></tr></table></figure>
<p><code>/usr/bin/amixer set Master 5%+</code> 就是一个 action。</p>
<p>暂时不用太深入，后续会专门写一篇文章来详细分析 process_devices()。</p>
<p><strong>4) 是否有接收到用户命令 (th-cmd)？</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(...) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    [...]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (retval) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        process_devices();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> ( cmd_fd != <span class="number">-1</span> &amp;&amp; FD_ISSET( cmd_fd, &amp;rfds ) ) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">command</span> *<span class="title">cmd</span> = <span class="title">read_command</span>( <span class="title">cmd_fd</span> );</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            obey_command( cmd );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">free</span>(cmd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>cmd_fd 是一个 socket：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">main()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    start_readers()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        cmd_fd = bind_cmdsocket(cmd_file);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">            cmd_fd = socket(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>);</span></pre></td></tr></table></figure>

<p>triggerhappy 支持使用 socket 通信以动态增加和删除输入设备，例如动态地添加要监测的输入设备 /的 /dev/input/event0：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> thd --socket /var/run/triggerhappy.socket</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> th-cmd --socket /var/run/triggerhappy.socket --add /dev/input/event0</span></span></pre></td></tr></table></figure>
<p>read_command() 和 obey_command() 负责读取和解析用户通过 socket 发送过来的命令，后面找时间写一些关于 domain socket 的文章。</p>
<p><strong>接下来，我们先学习一下 select 的机制、使用方法和注意事项</strong>。</p>
<p><strong>注意：<br>本文的写作目的不是为了描述 select() 完整的使用方法和内部实现，而是在有限的篇幅内尽量整理一下 I/O 多路复用相关的知识点，即仅仅是引子，更完整的内容仍需要小伙伴自行阅读相关书籍。</strong></p>
<h2 id="2-I-O-多路复用-Multiplexing-是为了解决什么问题-多文件阻塞"><a href="#2-I-O-多路复用-Multiplexing-是为了解决什么问题-多文件阻塞" class="headerlink" title="2. I/O 多路复用 ( Multiplexing ) 是为了解决什么问题: 多文件阻塞"></a>2. I/O 多路复用 ( Multiplexing ) 是为了解决什么问题: 多文件阻塞</h2><p>应用通常需要在多个文件描述符上阻塞，例如在键盘输入、进程间通信以及其他文件之间协调 I/O。</p>
<p>很多情况下，一个文件描述符依赖另一个文件描述符。只要是有 1 个文件描述符数据还没有准备好，比如发送了 read() 调用，但是还没有任何数据，就进程会阻塞在此 I/O 操作上，此时无法对其他的文件描述符提供服务。这导致应用效率变低，影响用户体验。</p>
<p>尤其是对于网络应用而言，可能会同时打开多个 socket，如果应用阻塞在某个 socket上，将引发很多问题。</p>
<p><strong>设计 I/O 多路复用就是为了解决上述问题：<br>支持应用同时在多个文件描述符 (普通文件、管道、套接字…) 上阻塞，并在其中某个文件描述符可以读写时收到通知。</strong></p>
<h2 id="3-I-O-多路复用设计思路"><a href="#3-I-O-多路复用设计思路" class="headerlink" title="3. I/O 多路复用设计思路"></a>3. I/O 多路复用设计思路</h2><p><strong>1&gt; 无 I/O 就绪</strong>：在有可用的文件描述符之前一直处于睡眠状态;</p>
<p><strong>2&gt; 任意文件描述符 I/O 就绪</strong>：唤醒应用，应用检查是哪个文件描述符可用了;</p>
<p><strong>3&gt; 执行 I/O 操作</strong>：应用处理所有 I/O 就绪的文件描述符，此时没有阻塞;</p>
<p><strong>4&gt; 返回第 1&gt; 步</strong>：重新开始;</p>
<p><strong>Linux 提供了三种 I/O 多路复用方案：</strong><br>-select()、poll() 和 epoll()。</p>
<p>本文先将学习重点放在 select() 上，同时也稍微了解一下 poll() 和 epoll()，明确三者的优缺点。</p>
<h2 id="4-select-的用法"><a href="#4-select-的用法" class="headerlink" title="4. select() 的用法"></a>4. select() 的用法</h2><h3 id="4-1-函数概述"><a href="#4-1-函数概述" class="headerlink" title="4.1 函数概述"></a>4.1 函数概述</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">$ man <span class="number">2</span> select</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/* According to POSIX.1-2001, POSIX.1-2008 */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/* According to earlier standards */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout)</span></span>;</span></pre></td></tr></table></figure>

<ul>
<li><p><strong>select() 会监测 3 个 文件描述符集，直到有 1 个或多个文件描述符集成为就绪态</strong>。</p>
</li>
<li><p>在给定的文件描述符 I/O 就绪之前并且还没有超出指定的时间限制，select() 会阻塞。</p>
</li>
</ul>
<h3 id="4-2-参数说明"><a href="#4-2-参数说明" class="headerlink" title="4.2 参数说明"></a>4.2 参数说明</h3><p><strong>1) 参数 fd_set * readfds、writefds、exceptfds：</strong></p>
<ul>
<li><p>select() 监测 3 种 I/O 事件(读、写、异常)，每 1 种事件对应 1 个文件描述符集。</p>
</li>
<li><p>每个描述符集存储在一个 fd_set 数据类型中，可以认为它是一个很大的位数组 (array<br>of bits)：</p>
</li>
</ul>
<p><img src="/images/linux/io/select_fd_set.png" alt="fd_set"></p>
<ul>
<li>select() 中间 3 个文件描述符集参数 readfds、writefds 和 exceptfds 分别对应了我们关心的可读、可写或处于异常条件的文件描述符集。</li>
</ul>
<p><strong>2) 操作文件描述符集的几个宏：</strong>  </p>
<ul>
<li><p>FD_ZERO：从指定集合中删除所有的文件描述符;</p>
</li>
<li><p>FD_SET：向指定集中添加一个文件描述符，而FD_CLR则从指定集中删除一个文件描述符;</p>
</li>
<li><p>FD_ISSET：检查一个文件描述符是否在给定集合中;</p>
</li>
<li><p>由于文件描述符集是静态建立的，所以<strong>文件描述符数存在上限值</strong>，而且存在最大文件描述符值，这两个值都是由 <strong>FD_SETSIZE</strong> 设置。<strong>在 Linux 中，该值是1024</strong>;</p>
</li>
</ul>
<p><strong>3) 参数 int nfds：最大文件描述符 + 1</strong></p>
<ul>
<li><p>参数 nfds 必须设为比 3 个文件描述符集合中所包含的最大文件描述符 + 1 的值。</p>
</li>
<li><p><strong>传递该参数是为了让内核不用去检查大于这个值的文件描述符是否属于上述 3 个文件描述符集合</strong>，这也从侧面说明了 select() 在内核里实现是会遍历 0~nfds 文件描述符。</p>
</li>
<li><p><strong>select() 的设计天生就没考虑到用于监测大量文件 I/O 就绪的情景</strong>。但是在 triggerhappy 里使用 select() 则是合理的，这是因为 一个系统上的 input 设备并不会太多，本文末尾还会对 select() 的优缺点进行总结。</p>
</li>
</ul>
<p><strong>4) 参数 struct timeval *timeout：</strong></p>
<ul>
<li><p><strong>timeout == NULL：永远等待</strong>。当所指定的描述符中的之一已就绪或捕捉到一个信号则返回。如果捕捉到一个信号，则返回 -1，errno 设置为 EINTR。</p>
</li>
<li><p><strong>timeout-&gt;tv_sec == 0 &amp;&amp; timeout-&gt;tv_usec == 0：完全不等待</strong>。测试所有指定的描述符并立即返回。</p>
</li>
<li><p><strong>timeout-&gt;tv_sec != 0 || timeout-&gt;tv_usec != 0：等待指定的秒数和微秒数</strong>。当指定的描述符之一已就绪，或超过指定的时间值时立即返回。如果在超时到期时还没有如何描述符准备好，则返回 0。</p>
</li>
</ul>
<h3 id="4-3-返回说明"><a href="#4-3-返回说明" class="headerlink" title="4.3 返回说明"></a>4.3 返回说明</h3><p><strong>1) return = -1：表示有错误发生。典型的错误码 (errno) 包括 EBADF 和 EINTR 等。</strong></p>
<ul>
<li><p>EBADF: 表示 readfds、writefds、exceptfds 中有非法文件描述符。</p>
</li>
<li><p>EINTR: 表示该调用被某个信号中断了。</p>
</li>
</ul>
<p><strong>2) return = 0：表示在有文件描述符成为就绪态之前 select() 已经超时。</strong></p>
<ul>
<li>在这种情况下，每个返回的文件描述符集合将被清空。</li>
</ul>
<p><strong>3) return &gt; 0：表示有 1 个或多个文件描述符已就绪。</strong></p>
<ul>
<li><p>返回值表示处于就绪态的文件描述符个数。</p>
</li>
<li><p>每个集合都修改成只包含相应类型的 I/O 就绪的文件描述符。</p>
</li>
<li><p>每个集合都需要检查通过 FD_ISSET() 以此找出发生的 I/O 事件是什么。</p>
</li>
<li><p>如果同一个文件描述符在 readfds、writefds 和 exceptfds 中同时被指定，且它对于多个 I/O 事件都处于就绪态的话，那么就会被统计多次。。例如<strong>同一描述符已准备好读和写，那么在返回值中会对其计 2 次</strong>。</p>
</li>
</ul>
<h3 id="4-4-注意事项"><a href="#4-4-注意事项" class="headerlink" title="4.4 注意事项"></a>4.4 注意事项</h3><ul>
<li><p><strong>每次调用 select() 之前，都要对所有参数进行初始化</strong>;</p>
</li>
<li><p>在 Linux 上，如果 select() 被信号中断的话，struct timeval 会被修改以表示剩余的超时时间;</p>
</li>
<li><p>exceptfds 常常被误解为在文件描述符上出现了异常情况，这是错误的。它其实与伪终端和流式套接字相关;</p>
</li>
<li><p><strong>如果在一个描述符上碰到了文件尾端，select() 会认为该描述符是可读的</strong>。此时调用 read()，会返回 0，这是 UNIX 系统指示到达文件尾端的方法。很多人错误地认为，当到达文件尾端时， select() 会指示一个异常条件。</p>
</li>
<li><p>如果想更详细地了解 I/O 多路复用的使用方法，可以学习一下开源软件 libevent。</p>
</li>
</ul>
<h3 id="4-5-最简单的-demo-程序"><a href="#4-5-最简单的-demo-程序" class="headerlink" title="4.5 最简单的 demo 程序"></a>4.5 最简单的 demo 程序</h3><p><strong>1) 初始化select() 的参数：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIMEOUT 5</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_LEN 1024</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    fd_set readfds;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* Wait on stdin for input. */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    FD_ZERO(&amp;readfds);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    FD_SET(STDIN_FILENO, &amp;readfds);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* Wait up to five seconds. */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    tv.tv_sec = TIMEOUT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    tv.tv_usec = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    [...]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>2) select () 监测是否有 I/O 就绪：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    [...]   <span class="comment">// 1) init select param</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* All right, now block! */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    ret = select (STDIN_FILENO + <span class="number">1</span>, &amp;readfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tv);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        perror (<span class="string">"select"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!ret) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">printf</span> (<span class="string">"%d seconds elapsed.\n"</span>, TIMEOUT);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    [...]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>3) 进行 I/O 操作：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    [...]   <span class="comment">// 1) init select param</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    [...]   <span class="comment">// 2) do select()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 3) do I/O</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (FD_ISSET(STDIN_FILENO, &amp;readfds)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">char</span> buf[BUF_LEN+<span class="number">1</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">int</span> len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        len = <span class="built_in">read</span> (STDIN_FILENO, buf, BUF_LEN);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (len == <span class="number">-1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            perror (<span class="string">"read"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (len) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            buf[len] = <span class="string">'\0'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">printf</span> (<span class="string">"read: %s\n"</span>, buf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>4) 运行效果：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gcc simple_select.c -o simple_select</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./simple_select </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">a</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">read: a</span></pre></td></tr></table></figure>
<p>启动程序时，程序会阻塞，这时从键盘敲入 ‘a’，程序会被唤醒。</p>
<h2 id="5-和-poll-epoll-进行简单对比-补充知识，非重点"><a href="#5-和-poll-epoll-进行简单对比-补充知识，非重点" class="headerlink" title="5. 和 poll / epoll 进行简单对比(补充知识，非重点)"></a>5. 和 poll / epoll 进行简单对比(补充知识，非重点)</h2><h3 id="5-1-对比-poll"><a href="#5-1-对比-poll" class="headerlink" title="5.1 对比 poll()"></a>5.1 对比 poll()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">$ man <span class="number">2</span> poll</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span><span class="params">(struct pollfd *fds, <span class="keyword">nfds_t</span> nfds, <span class="keyword">int</span> timeout)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span>   fd;         <span class="comment">/* file descriptor */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">short</span> events;     <span class="comment">/* requested events */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">short</span> revents;    <span class="comment">/* returned events */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr></table></figure>

<ul>
<li><p>poll()系统调用是 System V 的 I/O 多路复用解决方案。它解决了一些select()的不足，<strong>不过出于习惯或可移植性的考虑，select() 还是被频繁使用</strong>。</p>
</li>
<li><p>poll 的监测对象是 struct pollfd 数组，它可以精准的指定要监测的文件集合。而 select() 的文件描述符集合是静态的，<strong>当文件集合是稀疏的时，例如要监测文件描述符 ０ 和 1000 时，select() 的效率比 poll() 低很多</strong>。</p>
</li>
<li><p>select() 返回时会重新创建文件描述符集，因此每次调用都必须重新初始化。<strong>poll() 系统调用会把输入 (events 成员) 和输出 (revents 成员) 分离开，无需重新初始化数组就可以重新使用</strong>。</p>
</li>
</ul>
<h3 id="5-2-对比-epoll"><a href="#5-2-对比-epoll" class="headerlink" title="5.2 对比 epoll"></a>5.2 对比 epoll</h3><ul>
<li><p><strong>epoll 是 Linux 特有的 I/O 多路复用解决方案</strong>。</p>
</li>
<li><p>epoll 的实现比 poll() 和 select() 要复杂得多，epoll 解决了前两个都存在的基本性能问题，并增加了一些新的特性。</p>
</li>
<li><p>poll() 和 select() 每次调用时，内核必须遍历所有被监视的文件描述符。当文件描述符列表变得很大时，例如包含几百个甚至几千个文件描述符时，每次调用都要遍历列表就变成规模上的瓶颈。<strong>而 epoll 监测的对象是事件，无需遍历文件列表，所以在性能上有很大的提升</strong>。</p>
</li>
<li><p>select、poll、epoll 的后端都是 struct file_operations 里的 <code>unsigned int (*poll) (struct file *, struct poll_table_struct *);</code>。以后有机会的话，会继续跟进它们三者在内核里的实现。</p>
</li>
</ul>
<h2 id="6-继续分析-triggerhappy：thd-c-process-devices-：读取-input-数据"><a href="#6-继续分析-triggerhappy：thd-c-process-devices-：读取-input-数据" class="headerlink" title="6. 继续分析 triggerhappy：thd.c / process_devices()：读取 input 数据"></a>6. 继续分析 triggerhappy：thd.c / process_devices()：读取 input 数据</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">process_devices</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    for_each_device( &amp;check_device );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>devices.c / for_each_device() 会遍历所有 input 设备(内含 input 文件描述符)，对每一个设备都调用 check_device() 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">check_device</span><span class="params">( device *d )</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> fd = d-&gt;fd;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (FD_ISSET( fd, &amp;rfds )) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (read_event( d )) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">/* read error? Remove the device! */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">            remove_device( d-&gt;devname );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>thd.c / read_event() 执行input 数据的 read 操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_event</span><span class="params">( device *dev )</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    [...]           <span class="comment">// some init</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> <span class="title">ev</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">int</span> n = <span class="built_in">read</span>( fd, &amp;ev, <span class="keyword">sizeof</span>(ev) );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    [...]           <span class="comment">// parse and do action</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    run_triggers( ev.type, ev.code, ev.value, *keystate, dev );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>1 个input_event 事件相当于产生了一个 trigger,接下来的重点就是调用 trigger.c / run_triggers() 来触发用户自定义的 action 了。</p>
<p>鉴于大多数人的注意力无法在一篇文章里上集中太久，更多的内容将放在后面的文章里。建议大家可以先自行阅读相关书籍，不是自己理解到的东西是消化不了的。</p>
<h2 id="7-相关参考"><a href="#7-相关参考" class="headerlink" title="7. 相关参考"></a>7. 相关参考</h2><ul>
<li><p>《UNIX 环境高级编程》，14，16，17.6 章节</p>
</li>
<li><p>《Linux 系统编程》，2.10，4.2，8.7，11.7 章节</p>
</li>
<li><p>《Linux/UNIX系统编程手册》，63 章节</p>
</li>
<li><p>Libevent</p>
</li>
</ul>
<hr>
<h1 id="三、思考技术，也要思考人生"><a href="#三、思考技术，也要思考人生" class="headerlink" title="三、思考技术，也要思考人生"></a>三、思考技术，也要思考人生</h1><p><strong>学习技术，更要学习如何生活</strong>。</p>
<p>你和我各有一个苹果，如果我们交换苹果的话，我们还是只有一个苹果。但当你和我各有一个想法，我们交换想法的话，我们就都有两个想法了。</p>
<p><img src="/images/basic/wechat_channel.jpg" alt=""></p>
<p>对 <strong>嵌入式系统 (Linux、RTOS、OpenWrt、Android) 和 开源软件</strong> 感兴趣，想和更多人互相交流学习，请关注公众号：<strong>嵌入式Hacker</strong>。</p>
<p>觉得文章对你有价值的话，不妨点个 <strong>在看和点赞</strong> 哦。</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>这是一篇有趣的文章吗？</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="es-hacker 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/basic/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Linux-Program/" rel="tag"><i class="fa fa-tag"></i> Linux_Program</a>
          </div>

        
  <div class="post-widgets">
    <div class="wp_rating">
      <div id="wpac-rating"></div>
    </div>
  </div>


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/08/17/Linux%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%86%85%E5%B9%951/" rel="prev" title="Linux驱动开发 / 字符设备驱动内幕 (1)">
      <i class="fa fa-chevron-left"></i> Linux驱动开发 / 字符设备驱动内幕 (1)
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/08/29/%E6%AF%8F%E5%A4%A9%E4%B8%80%E7%82%B9C-%E4%B8%80%E4%B8%AA%E4%BC%98%E9%9B%85%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%87%BD%E6%95%B0%E5%BA%93/" rel="next" title="每天一点 C / 一个优雅的字符串函数库(Simple Dynamic Strings)">
      每天一点 C / 一个优雅的字符串函数库(Simple Dynamic Strings) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、进步的滞后性"><span class="nav-number">1.</span> <span class="nav-text">一、进步的滞后性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、triggerhappy-源码分析-3-select-的应用"><span class="nav-number">2.</span> <span class="nav-text">二、triggerhappy 源码分析 / 3.select() 的应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-thd-c-process-events-源码分析"><span class="nav-number">2.1.</span> <span class="nav-text">1. thd.c / process_events() 源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-process-events-的作用"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.1 process_events() 的作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-process-events-的内容：4-个步骤"><span class="nav-number">2.1.2.</span> <span class="nav-text">1.2 process_events() 的内容：4 个步骤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-I-O-多路复用-Multiplexing-是为了解决什么问题-多文件阻塞"><span class="nav-number">2.2.</span> <span class="nav-text">2. I/O 多路复用 ( Multiplexing ) 是为了解决什么问题: 多文件阻塞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-I-O-多路复用设计思路"><span class="nav-number">2.3.</span> <span class="nav-text">3. I/O 多路复用设计思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-select-的用法"><span class="nav-number">2.4.</span> <span class="nav-text">4. select() 的用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-函数概述"><span class="nav-number">2.4.1.</span> <span class="nav-text">4.1 函数概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-参数说明"><span class="nav-number">2.4.2.</span> <span class="nav-text">4.2 参数说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-返回说明"><span class="nav-number">2.4.3.</span> <span class="nav-text">4.3 返回说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-注意事项"><span class="nav-number">2.4.4.</span> <span class="nav-text">4.4 注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-最简单的-demo-程序"><span class="nav-number">2.4.5.</span> <span class="nav-text">4.5 最简单的 demo 程序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-和-poll-epoll-进行简单对比-补充知识，非重点"><span class="nav-number">2.5.</span> <span class="nav-text">5. 和 poll / epoll 进行简单对比(补充知识，非重点)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-对比-poll"><span class="nav-number">2.5.1.</span> <span class="nav-text">5.1 对比 poll()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-对比-epoll"><span class="nav-number">2.5.2.</span> <span class="nav-text">5.2 对比 epoll</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-继续分析-triggerhappy：thd-c-process-devices-：读取-input-数据"><span class="nav-number">2.6.</span> <span class="nav-text">6. 继续分析 triggerhappy：thd.c / process_devices()：读取 input 数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-相关参考"><span class="nav-number">2.7.</span> <span class="nav-text">7. 相关参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、思考技术，也要思考人生"><span class="nav-number">3.</span> <span class="nav-text">三、思考技术，也要思考人生</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">es-hacker</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">es-hacker</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  



  <script>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id    : ,
      el    : 'wpac-rating',
      color : 'fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>

  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
